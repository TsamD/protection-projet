
# README — Backup server (test)

## Objectif

Sauvegarder le dossier `/finance` de la machine **sso-compta.interface3.be** vers le serveur
**sso-backup-server.interface3.be** en mode **pull** via `rsync` et `ssh`.

La sauvegarde est **non intrusive** :

* aucune écriture sur la machine compta
* aucun arrêt de service
* pas de snapshot

---

## Principe

* Le backup est **initié depuis le backup-server**
* Les fichiers sont copiés depuis :


  sso-compta.interface3.be:/finance

* Vers le dossier local :


  ~/sauvegarde


---

## Script utilisé

Script : `faire-sauvegarde.sh`

Commande principale récupérée du prof :


rsync -avx --delete \
  -e "ssh -i /home/vagrant/.ssh/id_rsa" \
  vagrant@sso-compta.interface3.be:/finance/ sauvegarde


* `-a` : archive (fichiers, dossiers, permissions)
* `-v` : verbose
* `-x` : ne traverse pas d’autres systèmes de fichiers
* `--delete` : synchronise la destination avec la source

---

## Test manuel

Sur le backup-server :


cd ~
./faire-sauvegarde.sh


Vérifier :


ls -l sauvegarde


## Adaptation

Tu as raison — le README doit inclure **la gestion de la clé SSH** et le **known_hosts** (sinon on ne peut pas reproduire proprement et cron peut bloquer sur le prompt “Are you sure…”).

Voici une version **mise à jour**, toujours “fissa”, mais complète.

# README — Sauvegarde du dossier `/finance` (backup en pull)

## Objectif

Mettre en place une sauvegarde **automatisée, sécurisée et non intrusive** du dossier `/finance`
de **sso-compta.interface3.be** vers **sso-backup-server.interface3.be**.

---

## Architecture retenue

* Sauvegarde en **pull** (initiée par le backup-server)
* Connexion **SSH par clé**
* Exécution de `rsync` **en root côté compta** via sudo (sans SSH root)
* Synchronisation vers un répertoire local `~/sauvegarde`
* Automatisation via **cron** + logs dans `backup.log`

---

## 1) Préparation SSH (backup-server)

### 1.1 Génération de la clé

Sur **sso-backup-server** (user `vagrant`) :

```bash
ssh-keygen -t ed25519 -f /home/vagrant/.ssh/id_ed25519 -N ""
```

La clé privée est :

* `/home/vagrant/.ssh/id_ed25519`

La clé publique est :

* `/home/vagrant/.ssh/id_ed25519.pub`

### 1.2 Enregistrement du host (known_hosts)

Pour éviter tout prompt interactif au premier contact (cron), enregistrer l’empreinte SSH :

```bash
ssh-keyscan -H sso-compta.interface3.be >> /home/vagrant/.ssh/known_hosts
chmod 600 /home/vagrant/.ssh/known_hosts
```

> Alternative : faire un premier `ssh admin@sso-compta.interface3.be "echo OK"` et accepter le fingerprint.
> `ssh-keyscan` est préférable pour un README reproductible.

---

## 2) Préparation côté COMPTA (clé + sudo)

### 2.1 Autoriser la clé pour l’utilisateur LDAP `admin`

Sur **sso-compta** (en sudo), ajouter la clé publique du backup-server dans :

`/home/admin/.ssh/authorized_keys`

Exemple :

```bash
sudo mkdir -p /home/admin/.ssh
sudo chmod 700 /home/admin/.ssh
sudo sh -c 'cat >> /home/admin/.ssh/authorized_keys' < /home/vagrant/.ssh/id_ed25519.pub
sudo chmod 600 /home/admin/.ssh/authorized_keys
sudo chown -R admin:admin /home/admin/.ssh
```

(Si tu n’as pas le `.pub` localement sur compta, copie-colle la ligne depuis le backup-server.)

### 2.2 Sudo limité à rsync (sans mot de passe)

Créer une règle sudoers dédiée :

```bash
sudo visudo -f /etc/sudoers.d/backup-rsync
```

Contenu :

```text
admin ALL=(root) NOPASSWD: /usr/bin/rsync
```

Validation non-interactive (ne doit PAS demander de mot de passe) :

```bash
sudo -u admin sudo -n /usr/bin/rsync --version | head -1
```

---

## 3) Script de sauvegarde (backup-server)

Fichier : `/home/vagrant/faire-sauvegarde.sh`

```bash
rsync -avx --delete \
  --rsync-path="sudo /usr/bin/rsync" \
  -e "ssh -i /home/vagrant/.ssh/id_ed25519" \
  admin@sso-compta.interface3.be:/finance/ sauvegarde
```

* `--rsync-path="sudo /usr/bin/rsync"` : rsync s’exécute en root **sur compta** via sudo (pas de SSH root)
* `-a` : copie récursive + métadonnées
* `--delete` : destination = miroir de la source

Test manuel :

```bash
cd ~
./faire-sauvegarde.sh
ls -l ./sauvegarde
```

---

## 4) Automatisation (cron)

Sur **sso-backup-server** :

```bash
crontab -e
```

Ajouter :

```cron
0 2 * * * /home/vagrant/faire-sauvegarde.sh >> /home/vagrant/backup.log 2>&1
```

Vérification :

```bash
crontab -l
tail -n 50 /home/vagrant/backup.log
```

---

## Sécurité (résumé)

* ❌ Pas de SSH root
* ✅ Auth SSH par clé (pas de mot de passe)
* ✅ Empreinte SSH pré-enregistrée (pas de prompt en cron)
* ✅ Sudo strictement limité à `/usr/bin/rsync`




# README — Sauvegarde du dossier `/finance` (backup en pull)

## Objectif

Mettre en place une sauvegarde **automatisée, sécurisée et non intrusive** du dossier `/finance`
de **sso-compta.interface3.be** vers **sso-backup-server.interface3.be**.

---

## Architecture retenue

* Sauvegarde en **pull** (initiée par le backup-server)
* Connexion **SSH par clé**
* Exécution de `rsync` **en root côté compta** via sudo (sans SSH root)
* Synchronisation vers un répertoire local `~/sauvegarde`
* Automatisation via **cron** + logs dans `backup.log`

---

## 1) Préparation SSH (backup-server)

### 1.1 Génération de la clé

Sur **sso-backup-server** (user `vagrant`) :

```bash
ssh-keygen -t ed25519 -f /home/vagrant/.ssh/id_ed25519 -N ""
```

La clé privée est :

* `/home/vagrant/.ssh/id_ed25519`

La clé publique est :

* `/home/vagrant/.ssh/id_ed25519.pub`

### 1.2 Enregistrement du host (known_hosts)

Pour éviter tout prompt interactif au premier contact (cron), enregistrer l’empreinte SSH :

```bash
ssh-keyscan -H sso-compta.interface3.be >> /home/vagrant/.ssh/known_hosts
chmod 600 /home/vagrant/.ssh/known_hosts
```

> Alternative : faire un premier `ssh admin@sso-compta.interface3.be "echo OK"` et accepter le fingerprint.
> `ssh-keyscan` est préférable pour un README reproductible.

---

## 2) Préparation côté COMPTA (clé + sudo)

### 2.1 Autoriser la clé pour l’utilisateur LDAP `admin`

Sur **sso-compta** (en sudo), ajouter la clé publique du backup-server dans :

`/home/admin/.ssh/authorized_keys`

Exemple :

```bash
sudo mkdir -p /home/admin/.ssh
sudo chmod 700 /home/admin/.ssh
sudo sh -c 'cat >> /home/admin/.ssh/authorized_keys' < /home/vagrant/.ssh/id_ed25519.pub
sudo chmod 600 /home/admin/.ssh/authorized_keys
sudo chown -R admin:admin /home/admin/.ssh
```

(Si tu n’as pas le `.pub` localement sur compta, copie-colle la ligne depuis le backup-server.)

### 2.2 Sudo limité à rsync (sans mot de passe)

Créer une règle sudoers dédiée :

```bash
sudo visudo -f /etc/sudoers.d/backup-rsync
```

Contenu :

```text
admin ALL=(root) NOPASSWD: /usr/bin/rsync
```

Validation non-interactive (ne doit PAS demander de mot de passe) :

```bash
sudo -u admin sudo -n /usr/bin/rsync --version | head -1
```

---

## 3) Script de sauvegarde (backup-server)

Fichier : `/home/vagrant/faire-sauvegarde.sh`

```bash
rsync -avx --delete \
  --rsync-path="sudo /usr/bin/rsync" \
  -e "ssh -i /home/vagrant/.ssh/id_ed25519" \
  admin@sso-compta.interface3.be:/finance/ sauvegarde
```

* `--rsync-path="sudo /usr/bin/rsync"` : rsync s’exécute en root **sur compta** via sudo (pas de SSH root)
* `-a` : copie récursive + métadonnées
* `--delete` : destination = miroir de la source

Test manuel :

```bash
cd ~
./faire-sauvegarde.sh
ls -l ./sauvegarde
```

---

## 4) Automatisation (cron)

Sur **sso-backup-server** :

```bash
crontab -e
```

Ajouter :

```cron
0 2 * * * /home/vagrant/faire-sauvegarde.sh >> /home/vagrant/backup.log 2>&1
```

Vérification :

```bash
crontab -l
tail -n 50 /home/vagrant/backup.log
```

---

## Sécurité (résumé)

* ❌ Pas de SSH root
* ✅ Auth SSH par clé (pas de mot de passe)
* ✅ Empreinte SSH pré-enregistrée (pas de prompt en cron)
* ✅ Sudo strictement limité à `/usr/bin/rsync


