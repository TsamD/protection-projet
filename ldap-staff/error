==> default: Destroying VM and associated drives...
yok@yok-ThinkPad-13-2nd-Gen:~/Ephec/Vagrant/Examen/protection-before/ldap-staff$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==> default: Importing base box 'ubuntu/jammy64'...
==> default: Matching MAC address for NAT networking...
==> default: Checking if box 'ubuntu/jammy64' version '20241002.0.0' is up to date...
==> default: Setting the name of the VM: ldap-staff_default_1767767231115_24527
==> default: Fixed port collision for 22 => 2222. Now on port 2204.
==> default: Clearing any previously set network interfaces...
==> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
    default: Adapter 2: intnet
==> default: Forwarding ports...
    default: 22 (guest) => 2204 (host) (adapter 1)
==> default: Running 'pre-boot' VM customizations...
==> default: Booting VM...
==> default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2204
    default: SSH username: vagrant
    default: SSH auth method: private key
Timed out while waiting for the machine to boot. This means that
Vagrant was unable to communicate with the guest machine within
the configured ("config.vm.boot_timeout" value) time period.

If you look above, you should be able to see the error(s) that
Vagrant had when attempting to connect to the machine. These errors
are usually good hints as to what may be wrong.

If you're using a custom box, make sure that networking is properly
working and you're able to connect to the machine. It is a common
problem that networking isn't setup properly in these boxes.
Verify that authentication configurations are also setup properly,
as well.

If the box appears to be booting properly, you may want to increase
the timeout ("config.vm.boot_timeout") value.
yok@yok-ThinkPad-13-2nd-Gen:~/Ephec/Vagrant/Examen/protection-before/ldap-staff$ nano Vagrantfile 
yok@yok-ThinkPad-13-2nd-Gen:~/Ephec/Vagrant/Examen/protection-before/ldap-staff$ cat Vagrantfile 
# coding: utf-8

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"

#  config.vm.hostname = "ldap-staff"

  # VLAN
  config.vm.network "private_network", ip: "172.28.5.10", virtualbox__intnet: "staff", auto_config: false
 config.vm.provider "virtualbox" do |vb| 
    # MAC fixes pour matcher netplan (adapters 2..9)
  vb.customize ["modifyvm", :id, "--macaddress2", "080099AC1111"]
 end

  config.vm.provision "file", source: "./files/01-netplan.yaml", destination: "/tmp/01-netplan.yaml"

  config.vm.provision "file", source: "./files/install.txt", destination: "/home/vagrant/install.txt"
  config.vm.provision "file", source: "./files/sssd.conf", destination: "/home/vagrant/sssd.conf"
  config.vm.provision "file", source: "./files/ubuntuadmin-pass.txt", destination: "/home/vagrant/ubuntuadmin-pass.txt"
  
  config.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
  set -euo pipefail

  # Idée générale: https://documentation.ubuntu.com/server/how-to/sssd/with-ldap-and-kerberos
  # Spécifiquement pour l'accès ssh: https://www.howtoforge.com/how-to-setup-kerberos-server-and-client-on-ubuntu-1804-lts/

  # Mise à jour du fuseau horaire
  timedatectl set-timezone Europe/Brussels

  # Changement hostname - Kerberos utilise les noms, pas les adresses!
  hostnamectl set-hostname sso-staff.interface3.be
  echo -e "172.28.2.10 sso-server.interface3.be\n172.28.100.10 sso-desk.interface3.be\n172.28.5.10 sso-staff.interface3.be\n172.28.3.10 sso-compta.interface3.be\n172.28.2.11 sso-service.interface3.be\n172.28.200.10 yuki.interface3.be" >> /etc/hosts

  install -m 0644 /tmp/01-netplan.yaml /etc/netplan/01-netplan.yaml
  # netplan: installer et verrouiller les permissions
  install -o root -g root -m 0600 /tmp/01-netplan.yaml /etc/netplan/01-netplan.yaml

  # Si Vagrant a généré un /etc/netplan/50-vagrant.yaml, on verrouille aussi
  if [ -f /etc/netplan/50-vagrant.yaml ]; then
    chown root:root /etc/netplan/50-vagrant.yaml
    chmod 0600 /etc/netplan/50-vagrant.yaml
  fi

  netplan generate
  netplan apply

  # Protection des fichiers avec mots de passe et de configuration
  chmod 0600 ./ubuntuadmin-pass.txt
  chmod 0600 ./install.txt

  # Mettre à jour les packages
  DEBIAN_FRONTEND=noninteractive apt-get update

  # Charger debconf-utils et donner les paramètres par défaut utilisés par krb5-user (en fait krb5-config)
  # voir https://serverfault.com/questions/407317/passing-default-answers-to-apt-get-package-install-questions
  DEBIAN_FRONTEND=noninteractive apt-get -qq -y install debconf-utils
  debconf-set-selections < install.txt

  # Charger et installer les packages
  DEBIAN_FRONTEND=noninteractive apt-get -qq -y install sssd-ldap sssd-krb5 ldap-utils krb5-user

  # Configurer sssd pour le REALM et les serveurs LDAP et Kerberos
  mv ./sssd.conf /etc/sssd/sssd.conf
  chmod 0600 /etc/sssd/sssd.conf
  chown root:root /etc/sssd/sssd.conf
  systemctl start sssd.service
  pam-auth-update --enable mkhomedir

  # Enregister l'host dans Kerberos - nécessaire pour y accéder via ssh
  # voir https://documentation.ubuntu.com/server/how-to/sssd/with-ldap-and-kerberos/#sssd-and-kdc-spoofing
  kadmin -p ubuntu/admin -q "addprinc -randkey host/sso-staff.interface3.be" < ubuntuadmin-pass.txt
  kadmin -p ubuntu/admin -q "ktadd -k /etc/krb5.keytab host/sso-staff.interface3.be" < ubuntuadmin-pass.txt

  # Configurer sshd pour l'authentification via Kerberos
  echo "GSSAPIAuthentication yes" | tee /etc/ssh/sshd_config.d/50-allow-GSSAPI-authentication.conf
  echo "GSSAPICleanupCredentials yes" | tee -a /etc/ssh/sshd_config.d/50-allow-GSSAPI-authentication.conf
  systemctl restart sshd

  SHELL
end
