# coding: utf-8

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"

#  config.vm.hostname = "ldap-staff"

  # VLAN
  config.vm.network "private_network", ip: "172.28.5.10", virtualbox__intnet: "staff", auto_config: false
 config.vm.provider "virtualbox" do |vb| 
    # MAC fixes pour matcher netplan (adapters 2..9)
  vb.customize ["modifyvm", :id, "--macaddress2", "080099AC1111"]
 end

  config.vm.provision "file", source: "./files/01-netplan.yaml", destination: "/tmp/01-netplan.yaml"

  config.vm.provision "file", source: "./files/install.txt", destination: "/home/vagrant/install.txt"
  config.vm.provision "file", source: "./files/sssd.conf", destination: "/home/vagrant/sssd.conf"
  config.vm.provision "file", source: "./files/ubuntuadmin-pass.txt", destination: "/home/vagrant/ubuntuadmin-pass.txt"
  
  config.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
  set -euo pipefail

  # Idée générale: https://documentation.ubuntu.com/server/how-to/sssd/with-ldap-and-kerberos
  # Spécifiquement pour l'accès ssh: https://www.howtoforge.com/how-to-setup-kerberos-server-and-client-on-ubuntu-1804-lts/

  # Mise à jour du fuseau horaire
  timedatectl set-timezone Europe/Brussels

  # Changement hostname - Kerberos utilise les noms, pas les adresses!
  hostnamectl set-hostname sso-staff.interface3.be
  echo -e "172.28.2.10 sso-server.interface3.be\n172.28.100.10 sso-desk.interface3.be\n172.28.5.10 sso-staff.interface3.be\n172.28.3.10 sso-compta.interface3.be\n172.28.2.11 sso-service.interface3.be\n172.28.200.10 yuki.interface3.be" >> /etc/hosts

  install -m 0644 /tmp/01-netplan.yaml /etc/netplan/01-netplan.yaml
  # netplan: installer et verrouiller les permissions
  install -o root -g root -m 0600 /tmp/01-netplan.yaml /etc/netplan/01-netplan.yaml

  # Si Vagrant a généré un /etc/netplan/50-vagrant.yaml, on verrouille aussi
  if [ -f /etc/netplan/50-vagrant.yaml ]; then
    chown root:root /etc/netplan/50-vagrant.yaml
    chmod 0600 /etc/netplan/50-vagrant.yaml
  fi

  netplan generate
  netplan apply

  # Protection des fichiers avec mots de passe et de configuration
  chmod 0600 ./ubuntuadmin-pass.txt
  chmod 0600 ./install.txt

  # Mettre à jour les packages
  DEBIAN_FRONTEND=noninteractive apt-get update

  # Charger debconf-utils et donner les paramètres par défaut utilisés par krb5-user (en fait krb5-config)
  # voir https://serverfault.com/questions/407317/passing-default-answers-to-apt-get-package-install-questions
  DEBIAN_FRONTEND=noninteractive apt-get -qq -y install debconf-utils
  debconf-set-selections < install.txt

  # Charger et installer les packages
  DEBIAN_FRONTEND=noninteractive apt-get -qq -y install sssd-ldap sssd-krb5 ldap-utils krb5-user

  # Configurer sssd pour le REALM et les serveurs LDAP et Kerberos
  mv ./sssd.conf /etc/sssd/sssd.conf
  chmod 0600 /etc/sssd/sssd.conf
  chown root:root /etc/sssd/sssd.conf
  systemctl start sssd.service
  pam-auth-update --enable mkhomedir

  # Enregister l'host dans Kerberos - nécessaire pour y accéder via ssh
  # voir https://documentation.ubuntu.com/server/how-to/sssd/with-ldap-and-kerberos/#sssd-and-kdc-spoofing
  kadmin -p ubuntu/admin -q "addprinc -randkey host/sso-staff.interface3.be" < ubuntuadmin-pass.txt
  kadmin -p ubuntu/admin -q "ktadd -k /etc/krb5.keytab host/sso-staff.interface3.be" < ubuntuadmin-pass.txt

  # Configurer sshd pour l'authentification via Kerberos
  echo "GSSAPIAuthentication yes" | tee /etc/ssh/sshd_config.d/50-allow-GSSAPI-authentication.conf
  echo "GSSAPICleanupCredentials yes" | tee -a /etc/ssh/sshd_config.d/50-allow-GSSAPI-authentication.conf
  systemctl restart sshd

  SHELL
end
