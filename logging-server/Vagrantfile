# coding: utf-8

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"
 config.vm.network "private_network", ip: "172.28.128.123", auto_config: false
  config.vm.network "private_network", ip: "172.28.2.13", virtualbox__intnet: "servers", auto_config: false
 config.vm.provider "virtualbox" do |vb|
  vb.customize ["modifyvm", :id, "--macaddress2", "080027BC1133"]
  vb.customize ["modifyvm", :id, "--macaddress3", "080054AC1133"]
 end
  config.vm.provision "file", source: "./01-netplan.yaml", destination: "/tmp/01-netplan.yaml"

  config.vm.provision "file", source: "./users.txt", destination: "/home/vagrant/users.txt"
  config.vm.provision "file", source: "./watch-home-users.rules", destination: "/home/vagrant/watch-home-users.rules"
  config.vm.provision "file", source: "./10-server-centralisation.conf", destination: "/home/vagrant/10-server-centralisation.conf"
  
    
  
  config.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
  set -euo pipefail

  # Mise à jour du fuseau horaire - important pour les certificats
  timedatectl set-timezone Europe/Brussels

 # Changement hostname - Kerberos utilise les noms, pas les adresses!
  hostnamectl set-hostname sso-logging-server.interface3.be
  echo -e "172.28.2.10 sso-server.interface3.be\n172.28.100.10 sso-desk.interface3.be\n172.28.5.10 sso-staff.interface3.be\n172.28.3.10 sso-compta.interface3.be\n172.28.2.13 sso-logging-server.interface3.be\n172.28.2.11 sso-service.interface3.be\n172.28.2.12 sso-backup-server.interface3.be" >> /etc/hosts

# Accepte input du client dans le log
  mv /home/vagrant/10-server-centralisation.conf /etc/rsyslog.d/
  systemctl restart rsyslog

  # Création des utilisateurs
  chmod go-rw ./users.txt

  # --- Création des utilisateurs et de leurs fichiers ---

  # stephanie.deskclass
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/stephanie.deskclass --gecos "stephanie.deskclass" stephanie.deskclass
  echo "Mon fichier très personnel" > /home/stephanie.deskclass/personnel.txt

  # elise.deskclass
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/elise.deskclass --gecos "elise.deskclass" elise.deskclass
  echo "Mon fichier très personnel" > /home/elise.deskclass/personnel.txt

  # nisrine.techclass
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/nisrine.techclass --gecos "nisrine.techclass" nisrine.techclass
  echo "Mon fichier très personnel" > /home/nisrine.techclass/personnel.txt

  # alessia.techclass 
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/alessia.techclass --gecos "alessia.techclass" alessia.techclass
  echo "Mon fichier très personnel" > /home/alessia.techclass/personnel.txt

  # sven.staff
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/sven.staff --gecos "sven.staff" sven.staff
  echo "Mon fichier très personnel" > /home/sven.staff/personnel.txt

  # julie.staff
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/julie.staff --gecos "julie.staff" julie.staff
  echo "Mon fichier très personnel" > /home/julie.staff/personnel.txt

  # saliha.compta
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/saliha.compta --gecos "saliha.compta" saliha.compta
  echo "Mon fichier très personnel" > /home/saliha.compta/personnel.txt

  # olivier.compta
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/olivier.compta --gecos "olivier.compta" olivier.compta
  echo "Mon fichier très personnel" > /home/olivier.compta/personnel.txt

  # johan
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/johan --gecos "johan" johan
  echo "Mon fichier très personnel" > /home/johan/personnel.txt

  # fatima
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/fatima --gecos "fatima" fatima
  echo "Mon fichier très personnel" > /home/fatima/personnel.txt

  # ibtissam
  adduser --force-badname  --quiet --disabled-password --shell /bin/bash --home /home/ibtissam --gecos "ibtissam" ibtissam
  echo "Mon fichier très personnel" > /home/ibtissam/personnel.txt

  # --- Application des mots de passe ---
  # Cette commande s'exécute une fois que tous les comptes sont créés
  chpasswd < users.txt

 

  # Chargement des packages, en mode non-interactif(!)
  DEBIAN_FRONTEND=noninteractive apt-get update
  DEBIAN_FRONTEND=noninteractive apt-get install -y logwatch auditd nginx socat

  # Configuration de auditd pour synchronisation rapide sur le disque
  sed s/"flush = INCREMENTAL_ASYNC"/"flush = SYNC"/ /etc/audit/auditd.conf

  # Configuration de la règle pour auditd et démarrage auditd
  mv /home/vagrant/watch-home-users.rules /etc/audit/rules.d/watch-home-users.rules
  augenrules --check
  augenrules --load
  augenrules --check
  service auditd start
  systemctl enable auditd

  install -m 0644 /tmp/01-netplan.yaml /etc/netplan/01-netplan.yaml
  # netplan: installer et verrouiller les permissions
  install -o root -g root -m 0600 /tmp/01-netplan.yaml /etc/netplan/01-netplan.yaml

  # Si Vagrant a généré un /etc/netplan/50-vagrant.yaml, on verrouille aussi
  if [ -f /etc/netplan/50-vagrant.yaml ]; then
    chown root:root /etc/netplan/50-vagrant.yaml
    chmod 0600 /etc/netplan/50-vagrant.yaml
  fi

  netplan generate
  netplan apply

  SHELL

end
